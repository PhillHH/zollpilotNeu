# Security Baseline

## Authentication

- Authentication uses email + password.
- Passwords are hashed with bcrypt.
- Sessions are stored in the DB and referenced by HTTP-only cookies.
- JWTs are intentionally not used for business logic to keep revocation simple.

## Authorization

- Follow least privilege when adding DB roles.
- RBAC is enforced exclusively in the backend (OWNER > ADMIN > USER).
- No business logic in the frontend.
- All data access goes through the API layer.

## Rate Limiting & Abuse Protection

The API implements rate limiting to protect against abuse and ensure fair resource usage.

### Configuration

| Endpoint Category | Limit | Window |
|-------------------|-------|--------|
| Default | 60 requests | 1 minute |
| PDF Export | 10 requests | 1 minute |
| Validation | 30 requests | 1 minute |
| Fields (Autosave) | 120 requests | 1 minute |

### Scope

Rate limits are applied **per tenant**, not per user. This means:
- All users in a tenant share the same rate limit pool
- Prevents individual users from exhausting resources
- Fair distribution across customers

### Implementation

- **Storage**: In-Memory (MVP) ‚Äì consider Redis for production scaling
- **Algorithm**: Sliding Window Counter
- **Identification**: Based on `tenant_id` from session

### Response on Limit Exceeded

When rate limited, the API returns:

```http
HTTP/1.1 429 Too Many Requests
Retry-After: 45
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1706291234

{
  "error": {
    "code": "RATE_LIMITED",
    "message": "Zu viele Anfragen. Bitte sp√§ter erneut versuchen."
  },
  "requestId": "abc-123-xyz"
}
```

### Frontend Handling

The frontend displays:
- User-friendly error message
- Automatic retry suggestion
- Support code (requestId) for debugging

## Request Tracing

Every API request receives a unique `requestId` for debugging and support:

1. Generated by `RequestIdMiddleware` at request entry
2. Included in all log entries (JSON format)
3. Returned in error responses (`requestId` field)
4. Embedded in PDF footer for document tracing
5. Exposed via `X-Request-Id` response header

### Using Request IDs

**For Users**: Display as "Support-Code" in error messages
**For Operators**: Search logs by `request_id`
**For Debugging**: Correlate frontend errors with backend logs

## Logging

All logs are structured JSON for observability:

```json
{
  "timestamp": "2026-01-26T10:30:00.000Z",
  "level": "ERROR",
  "logger": "api",
  "message": "Validation failed",
  "request_id": "abc-123",
  "user_id": "user-456",
  "tenant_id": "tenant-789",
  "path": "/cases/123/validate",
  "error_code": "CASE_INVALID"
}
```

### Log Levels

- **INFO**: Normal operations, request completion
- **WARNING**: Validation errors, rate limiting
- **ERROR**: Business logic failures, auth failures
- **EXCEPTION**: Unhandled exceptions (includes stack trace)

---

## Production Hardening Checklist

### ‚úÖ Before Go-Live

#### Secrets & Configuration

- [ ] Generate strong `SESSION_SECRET` (min 32 chars): `openssl rand -hex 32`
- [ ] Set `SESSION_COOKIE_SECURE=true`
- [ ] Set `SESSION_COOKIE_SAMESITE=Strict`
- [ ] Set `SESSION_COOKIE_DOMAIN` to your domain
- [ ] Set `NODE_ENV=production`
- [ ] Set `DEBUG_MODE=false`
- [ ] Remove default/example passwords from DB
- [ ] Verify no secrets in Docker images or Git history

#### Network & CORS

- [ ] Set `WEB_ORIGIN` to production domain (no trailing slash)
- [ ] Configure SSL/TLS (use managed certificates)
- [ ] Set up reverse proxy (nginx/Caddy/Cloud LB)
- [ ] Enable HTTP Strict Transport Security (HSTS)
- [ ] Configure Content Security Policy (CSP) headers

#### Database

- [ ] Use managed PostgreSQL (RDS, Cloud SQL, etc.)
- [ ] Strong database password
- [ ] Network isolation (VPC, private subnet)
- [ ] Enable SSL connections
- [ ] Regular automated backups
- [ ] Point-in-time recovery enabled

#### Containers

- [ ] Verify containers run as non-root user
- [ ] Pin base image versions (no `latest`)
- [ ] Scan images for vulnerabilities (Trivy)
- [ ] Remove unnecessary packages
- [ ] Set resource limits (CPU, memory)

#### Monitoring & Alerting

- [ ] Configure log aggregation (ELK, CloudWatch, Datadog)
- [ ] Set up health check monitoring
- [ ] Configure uptime alerts
- [ ] Monitor error rate threshold
- [ ] Monitor rate limit hits

### ‚ö†Ô∏è Recommended (Post-Launch)

#### Additional Security

- [ ] Implement CSRF tokens for state-changing requests
- [ ] Add account lockout after N failed logins
- [ ] Implement password strength policy
- [ ] Add session invalidation on password change
- [ ] Consider 2FA for admin users

#### Infrastructure

- [ ] Move rate limiting to Redis (for horizontal scaling)
- [ ] Implement circuit breaker pattern
- [ ] Set up staging environment
- [ ] Configure auto-scaling
- [ ] Implement blue-green deployments

#### Compliance

- [ ] Privacy policy page
- [ ] Terms of service page
- [ ] Cookie consent banner (if required)
- [ ] GDPR data export capability
- [ ] Data retention policy

### üîí Security Headers

Recommended headers for reverse proxy:

```nginx
# nginx example
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

### üîë Session Security

Current implementation:

| Setting | Value | Purpose |
|---------|-------|---------|
| `HttpOnly` | ‚úÖ true | Prevents XSS access to cookie |
| `Secure` | ‚ö†Ô∏è env-based | HTTPS only (set true in prod) |
| `SameSite` | ‚ö†Ô∏è Lax (default) | CSRF protection (use Strict in prod) |
| `Domain` | ‚ö†Ô∏è env-based | Cookie scope |
| `MaxAge` | 2h (default) | Session lifetime |

### üìä Security Monitoring

Things to monitor in production:

1. **Failed login attempts** per IP/user
2. **Rate limit hits** per tenant
3. **401/403 response rate**
4. **Unusual traffic patterns**
5. **Database connection errors**
6. **PDF generation failures**

